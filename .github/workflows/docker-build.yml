name: Docker Build & Push (Reflex Export)

on:
  push:
    branches: ["main"]     # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushã§å®Ÿè¡Œ
  workflow_dispatch:       # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ---
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # --- Reflexã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« ---
      - name: Install Reflex
        run: |
          if [ ! -f "requirements.txt" ]; then
            echo "ã‚¨ãƒ©ãƒ¼: requirements.txt ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"
            echo "ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ã€Reflex ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆã« requirements.txt ã‚’é…ç½®ã—ã¦ãã ã•ã„ã€‚"
            exit 1
          else
            echo "ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
            pip install --upgrade pip
            pip install -r requirements.txt
          fi

      # --- Reflex Exportï¼ˆZipç”Ÿæˆï¼‰ ---
      - name: Export Reflex project
        run: |
          reflex export
          echo "âœ… Reflex export (frontend + backend) å®Œäº†"

      # --- Zipå±•é–‹ï¼ˆReflex 0.5.3å¯¾å¿œï¼‰ ---
      - name: Unzip exported build
        run: |
          mkdir -p frontend backend

          # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰Zipã‚’å±•é–‹
          if [ -f frontend.zip ]; then
            unzip -o frontend.zip -d frontend
            echo "âœ… frontend.zip ã‚’å±•é–‹ã—ã¾ã—ãŸ"
          else
            echo "âš ï¸ frontend.zip ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi

          # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰Zipã‚’å±•é–‹
          if [ -f backend.zip ]; then
            unzip -o backend.zip -d backend
            echo "âœ… backend.zip ã‚’å±•é–‹ã—ã¾ã—ãŸ"
          else
            echo "âš ï¸ backend.zip ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
          
          echo "âœ… å±•é–‹å®Œäº†: frontend/, backend/ ãŒä½œæˆã•ã‚Œã¾ã—ãŸ"

      # --- Dockerfileé…ç½® ---
      - name: Copy Dockerfiles into export directories
        run: |
          cp Dockerfile_backend backend/Dockerfile
          cp Dockerfile_frontend frontend/Dockerfile
          echo "âœ… Dockerfile ã‚’é…ç½®ã—ã¾ã—ãŸ"

      # GitHub Container Registryã¸ãƒ­ã‚°ã‚¤ãƒ³
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # --- docker-compose build ---
      - name: Docker Compose Build
        run: |
          docker compose build
          echo "âœ… docker-compose build å®Œäº†"

      # --- ã‚¿ã‚°ä»˜ã‘ã—ã¦Push ---
      - name: Tag & Push images to GHCR
        run: |
          GHCR=ghcr.io/${{ github.repository }}

          echo "ğŸš€ ã‚¿ã‚°ä»˜ã‘ã¨Pushé–‹å§‹"
          docker tag reflex-backend $GHCR/reflex-backend:latest
          docker tag reflex-frontend $GHCR/reflex-frontend:latest

          docker push $GHCR/reflex-backend:latest
          docker push $GHCR/reflex-frontend:latest
          echo "âœ… GHCRã¸Pushå®Œäº†"