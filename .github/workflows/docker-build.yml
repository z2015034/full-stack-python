name: Docker Build & Push (Reflex Export)

on:
  push:
    branches: ["main"]     # main„Éñ„É©„É≥„ÉÅ„Å∏„ÅÆpush„ÅßÂÆüË°å
  workflow_dispatch:       # ÊâãÂãïÂÆüË°å„ÇÇÂèØ

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # „É™„Éù„Ç∏„Éà„É™„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- PythonÁí∞Â¢É„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó ---
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # --- Reflex„Ç§„É≥„Çπ„Éà„Éº„É´ ---
      - name: Install Reflex
        run: |
          if [ ! -f "requirements.txt" ]; then
            echo "„Ç®„É©„Éº: requirements.txt „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ"
            echo "„Åì„ÅÆ„Çπ„ÇØ„É™„Éó„Éà„ÇíÂÆüË°å„Åô„ÇãÂâç„Å´„ÄÅReflex „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„É´„Éº„Éà„Å´ requirements.txt „ÇíÈÖçÁΩÆ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
            exit 1
          else
            echo "‰æùÂ≠ò„Éë„ÉÉ„Ç±„Éº„Ç∏„Çí„Ç§„É≥„Çπ„Éà„Éº„É´‰∏≠..."
            pip install --upgrade pip
            pip install -r requirements.txt
          fi

      # --- Reflex ExportÔºàZipÁîüÊàêÔºâ ---
      - name: Export Reflex project
        run: |
          reflex export
          echo "‚úÖ Reflex export (frontend + backend) ÂÆå‰∫Ü"

      # --- ZipÂ±ïÈñãÔºàReflex 0.5.3ÂØæÂøúÔºâ ---
      - name: Unzip exported build
        run: |
          mkdir -p frontend backend

          # „Éï„É≠„É≥„Éà„Ç®„É≥„ÉâZip„ÇíÂ±ïÈñã
          if [ -f frontend.zip ]; then
            unzip -o frontend.zip -d frontend
            echo "‚úÖ frontend.zip „ÇíÂ±ïÈñã„Åó„Åæ„Åó„Åü"
          else
            echo "‚ö†Ô∏è frontend.zip „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì"
          fi

          # „Éê„ÉÉ„ÇØ„Ç®„É≥„ÉâZip„ÇíÂ±ïÈñã
          if [ -f backend.zip ]; then
            unzip -o backend.zip -d backend
            echo "‚úÖ backend.zip „ÇíÂ±ïÈñã„Åó„Åæ„Åó„Åü"
          else
            echo "‚ö†Ô∏è backend.zip „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì"
          fi

          echo "‚úÖ Â±ïÈñãÂÆå‰∫Ü: frontend/, backend/ „Åå‰ΩúÊàê„Åï„Çå„Åæ„Åó„Åü"

      # --- DockerfileÈÖçÁΩÆ ---
      - name: Copy Dockerfiles into export directories
        run: |
          cp Dockerfile_backend backend/Dockerfile
          cp Dockerfile_frontend frontend/Dockerfile
          echo "‚úÖ Dockerfile „ÇíÈÖçÁΩÆ„Åó„Åæ„Åó„Åü"

      # GitHub Container Registry„Å∏„É≠„Ç∞„Ç§„É≥
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # --- docker-compose build ---
      - name: Docker Compose Build
        run: |
          docker compose build
          echo "‚úÖ docker-compose build ÂÆå‰∫Ü"

      - name: Debug Docker images
        run: docker images

      # --- „Çø„Ç∞‰ªò„Åë„Åó„Å¶Push ---
      - name: Tag & Push images to GHCR
        run: |
          GHCR=ghcr.io/${{ github.repository }}

          echo "üöÄ „Çø„Ç∞‰ªò„Åë„Å®PushÈñãÂßã"

          BACKEND_IMAGE=$(docker images --format "{{.Repository}}" | grep backend | head -n 1)
          FRONTEND_IMAGE=$(docker images --format "{{.Repository}}" | grep frontend | head -n 1)

          echo "Detected images:"
          echo "  backend -> $BACKEND_IMAGE"
          echo "  frontend -> $FRONTEND_IMAGE"

          docker tag $BACKEND_IMAGE $GHCR/reflex-backend:latest
          docker tag $FRONTEND_IMAGE $GHCR/reflex-frontend:latest

          docker push $GHCR/reflex-backend:latest
          docker push $GHCR/reflex-frontend:latest
          echo "‚úÖ GHCR„Å∏PushÂÆå‰∫Ü"